{% extends "../layout/main.html" %}

{% block pretitle %}
	<div class="router-stats well well-small" data-name="application" data-inputid="{{ application.id }}">Loading...</div>
{% end %}

{% block pagetitle %}
	Application: {{ application.name }}
{% end %}

{% block body %}
	<div class="btn-toolbar">
		<div class="btn-group btn-group-header">
			<a class="btn" href="/workspace/{{ application.workspace.id }}/applications"><i class="icon-backward"></i> Back to {{ application.workspace.name }}</a>
		</div>
		<div class="btn-group btn-group-header">
			<a class="btn" href="/application/{{ application.id }}/newversion"><i class="icon-plus"></i> Create new version</a>
		</div>
		<div class="btn-group btn-group-header">
			<a class="btn" href="/job/list/application/{{ application.id }}">All Jobs</a>
			{% if user_permissions.has_permission(PERMISSION.APPLICATION_SERVICE_DETAIL, application.workspace_id) %}
				<a class="btn" href="/application/{{ application.id }}/services">Services</a>
			{% end %}
			<a class="btn" href="/job/list/application/{{ application.id }}?sub=cron">Crons</a>
		</div>
		<!--
		{% if user_permissions.has_permission(PERMISSION.APPLICATION_DELETE, application.workspace_id) %}
			{% if application.can_delete() %}
				<form method="POST" action="/application/{{ application.id }}/delete" style="display: inline;">
					<i class="icon-trash"></i>
					<input type="submit" class="btn btn-mini btn-danger" value="Delete Application" />
				</form>
			{% end %}
		{% end %}
		-->
	</div>

	<table class="table table-striped table-bordered">
		{% if current_version %}
			<tr>
				<th>Current version</th>
				<th>State</th>
				<th>Health</th>
				<th>Instances</th>
				<th>Actions</th>
			</tr>
			<tr>
				<td>
					<a href="/version/{{ current_version.id }}">Version {{ current_version.version }}</a>
				</td>
				<td>
					<span class="version-{{ current_version.state }}">{{ nice_state(current_version.state) }}</span>
				</td>
				<td>
					{% set health_data = current_version.health %}
					{% if health_data['overall'] == constants.HEALTH.OK %}
						{{ health_data['overall'] }}
					{% else %}
						{% for itype in health_data['types'] %}
							{{ itype }}: {{ health_data['types'][itype]['state'] }} - {{ health_data['types'][itype]['message'] }}<br />
						{% end %}
					{% end %}
				</td>
				<td>
					<a href="/version/{{ current_version.id }}">{{ instance_counts[current_version.id] }} instance(s) of {{ len(current_version.instance_types) }} type(s)</a>
				</td>
				<td>
					<div class="table-button-box">
						{% if current_version.state == constants.VERSION.PREPARED %}
							<form method="POST" action="/version/{{ current_version.id }}/register">
								<input type="submit" class="btn btn-mini btn-success" value="Register" />
							</form>
						{% end %}
						{% if current_version.state == constants.VERSION.READY or current_version.state == constants.VERSION.PREPARED %}
							<form method="POST" action="/version/{{ current_version.id }}/start">
								<input type="submit" class="btn btn-mini btn-success" value="Start" />
							</form>
						{% end %}
						{% if current_version.state == constants.VERSION.RUNNING %}
							<form method="POST" action="/version/{{ current_version.id }}/stop">
								<input type="submit" class="btn btn-mini btn-danger" value="Stop" />
							</form>
						{% end %}
						{% if current_version.state == constants.VERSION.READY %}
							<form method="POST" action="/version/{{ current_version.id }}/deregister">
								<input type="submit" class="btn btn-mini btn-warning" value="De Register" />
							</form>
						{% end %}
						{% if current_version.state == constants.VERSION.RUNNING and not current_version.is_current %}
							<form method="POST" action="/version/{{ current_version.id }}/setcurrent">
								<input type="submit" class="btn btn-mini btn-primary" value="Make Current" />
							</form>
						{% end %}
						{% if not current_version.is_current and current_version.state == constants.VERSION.PREPARED %}
							<form method="POST" action="/version/{{ current_version.id }}/delete">
								<input type="submit" class="btn btn-mini btn-danger" value="Delete" />
							</form>
						{% end %}
					</div>
				</td>
			</tr>
	</table>
	
	<table class="table table-striped table-bordered">
		<tr>
			<th>Number</th>
			<th>Current</th>
			<th>State</th>
			<th>Health</th>
			<th>Instances</th>
			<th>Actions</th>
		</tr>
		{% end %}
		{% for version in versions %}
			{% module Template("application/version_row.html", version=version, instance_counts=instance_counts, nice_state=nice_state, constants=constants) %}
		{% end %}
	</table>

	{% module Template("include/pagination.html", page_data=versions_pagination) %}
{% end %}